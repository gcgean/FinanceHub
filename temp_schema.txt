generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  OPERATOR
  CLIENT
}

enum TransactionType {
  REVENUE
  EXPENSE
}

enum TransactionStatus {
  NEW
  SUGGESTED
  PENDING
  APPROVED
  REVIEWED
  LOCKED
}

enum PendencyType {
  CATEGORIZATION
  ATTACHMENT
  COST_CENTER
  APPROVAL
  REVIEW
}

enum PendencyPriority {
  HIGH
  MEDIUM
  LOW
}

enum PendencyStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  OVERDUE
}

enum ImportSource {
  EXCEL
  RECEIPT
  API
}

enum ImportStatus {
  QUEUED
  PROCESSING
  DONE
  FAILED
}

enum LedgerOperation {
  DEBITO
  CREDITO
}

enum ChartPlanType {
  SINTETICA
  ANALITICA
}

enum RevenueExpense {
  RECEITA
  DESPESA
}

enum DebitCredit {
  DEBITO
  CREDITO
}

enum FixedVariable {
  FIXO
  VARIAVEL
}

enum CostExpense {
  CUSTO
  DESPESA
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  CONFIRM
}

enum CompanyPlan {
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum CompanyStatus {
  ACTIVE
  INACTIVE
  PENDING
}

model Company {
  id        String        @id @default(cuid())
  name      String
  cnpj      String?       @unique
  email     String?
  phone     String?
  plan      CompanyPlan   @default(PROFESSIONAL)
  status    CompanyStatus @default(ACTIVE)
  createdAt DateTime      @default(now())
  users     User[]
  txs       Transaction[]
  pendings  Pendency[]
  imports   ImportJob[]

  accounts       Account[]
  costCenters    CostCenter[]
  chartAccounts  ChartAccount[]
  ledgerEntries  BankLedgerEntry[]
  audit          AuditLog[]

  dataSources    DataSource[]
  importFiles    ImportFile[]
  rawEvents      RawEvent[]
  importErrors   ImportError[]
  externalRefs   ExternalRef[]
  stgCustomers   StgCustomer[]
  stgSuppliers   StgSupplier[]
  stgProducts    StgProduct[]
  stgInventories StgInventory[]
  stgSalesInvoices StgSalesInvoice[]
  stgPurchaseInvoices StgPurchaseInvoice[]

  customers      Customer[]
  suppliers      Supplier[]
  products       Product[]
  apTitles       ApTitle[]
  arTitles       ArTitle[]
  customerDeactivations CustomerDeactivation[]
  sales          Sale[]
  paymentMethods PaymentMethod[]
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String
  passwordHash String
  role         UserRole  @default(OPERATOR)
  companyId    String?
  company      Company?  @relation(fields: [companyId], references: [id])
  createdAt    DateTime  @default(now())

  updatedLedgerEntries BankLedgerEntry[] @relation("LedgerUpdatedBy")
  audit                AuditLog[]

  requestedImportJobs  ImportJob[] @relation("UserRequestedJobs")
  importFilesUploaded  ImportFile[]
}

model Transaction {
  id                 String            @id @default(cuid())
  companyId           String
  company             Company           @relation(fields: [companyId], references: [id])
  date                DateTime
  description         String
  value               Float
  type                TransactionType
  category            String
  categoryConfidence  Int?
  account             String
  status              TransactionStatus
  costCenter          String?
  attachmentUrl       String?
  notes               String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  pendencies          Pendency[]

  @@index([companyId, date])
}

model AccountType {
  id          String   @id @default(cuid())
  code        String   @unique
  description String
  createdAt   DateTime @default(now())
  accounts    Account[]
}

model Account {
  id               String        @id @default(cuid())
  companyId         String
  company           Company       @relation(fields: [companyId], references: [id])
  code             String
  description      String
  externalCode     String?
  active           Boolean       @default(true)
  useInCashFlow    Boolean       @default(true)
  superOnly        Boolean       @default(false)
  defaultConfirmed Boolean       @default(false)
  accountTypeId    String?
  accountType      AccountType?  @relation(fields: [accountTypeId], references: [id])
  createdAt        DateTime      @default(now())

  ledgerEntries BankLedgerEntry[]

  @@unique([companyId, code])
  @@unique([companyId, externalCode])
  @@index([companyId])
}

model CostCenter {
  id          String   @id @default(cuid())
  companyId    String
  company      Company  @relation(fields: [companyId], references: [id])
  code        String
  externalCode String?
  description String
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  ledgerSplits BankLedgerEntrySplit[]

  @@unique([companyId, code])
  @@unique([companyId, externalCode])
  @@index([companyId])
}

model ChartAccount {
  id                              String        @id @default(cuid())
  companyId                        String?
  company                          Company?      @relation(fields: [companyId], references: [id])
  code                            String
  description                     String
  active                          Boolean       @default(true)
  isSuper                         Boolean       @default(false)
  planType                         ChartPlanType
  parentId                         String?
  parent                           ChartAccount? @relation("ChartAccountHierarchy", fields: [parentId], references: [id])
  children                         ChartAccount[] @relation("ChartAccountHierarchy")
  revenueExpense                  RevenueExpense
  debitCredit                     DebitCredit
  fixedVariable                   FixedVariable
  costExpense                     CostExpense
  accountingCode                  String?
  dreHide                         Boolean       @default(false)
  dreGroupOtherFinIncome          Boolean       @default(false)
  dreGroupDeductionsTaxes         Boolean       @default(false)
  dreGroupInvestments             Boolean       @default(false)
  dreGroupSalesMarketing          Boolean       @default(false)
  dreGroupProfitSharing           Boolean       @default(false)
  cashflowHide                    Boolean       @default(false)
  createdAt                       DateTime      @default(now())

  allocations ChartAccountAllocation[]
  ledgerSplits BankLedgerEntrySplit[]

  @@index([companyId])
  @@index([parentId])
}

model ChartAccountAllocation {
  id             String   @id @default(cuid())
  chartAccountId  String
  chartAccount    ChartAccount @relation(fields: [chartAccountId], references: [id])
  year           Int
  annualTotal     Float   @default(0)
  createdAt      DateTime @default(now())

  lines ChartAccountAllocationLine[]

  @@unique([chartAccountId, year])
}

model ChartAccountAllocationLine {
  id            String   @id @default(cuid())
  allocationId  String
  allocation    ChartAccountAllocation @relation(fields: [allocationId], references: [id])
  month         Int
  amount        Float    @default(0)

  @@unique([allocationId, month])
}

model BankLedgerEntry {
  id            String         @id @default(cuid())
  companyId      String
  company        Company        @relation(fields: [companyId], references: [id])
  code          Int
  issueDate     DateTime
  paymentDate   DateTime?
  accountId     String?
  account       Account?       @relation(fields: [accountId], references: [id])
  documentType  String?
  documentNumber String?
  checkNumber   String?
  entityCode    String?
  amount        Float
  operation     LedgerOperation
  history       String?
  confirmed     Boolean        @default(false)
  printOnClose  Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?
  updatedById   String?
  updatedBy     User?          @relation("LedgerUpdatedBy", fields: [updatedById], references: [id])

  splits        BankLedgerEntrySplit[]
  attachments   Attachment[]

  @@index([companyId, issueDate])
  @@index([accountId])
}

model BankLedgerEntrySplit {
  id            String       @id @default(cuid())
  entryId       String
  entry         BankLedgerEntry @relation(fields: [entryId], references: [id])
  chartAccountId String
  chartAccount  ChartAccount @relation(fields: [chartAccountId], references: [id])
  costCenterId  String?
  costCenter    CostCenter?  @relation(fields: [costCenterId], references: [id])
  splitAmount   Float
  createdAt     DateTime     @default(now())

  @@index([entryId])
  @@index([chartAccountId])
}

model Attachment {
  id          String   @id @default(cuid())
  entryId     String
  entry       BankLedgerEntry @relation(fields: [entryId], references: [id])
  fileName    String
  url         String
  mime        String?
  size        Int?
  createdAt   DateTime @default(now())
}

model AuditLog {
  id        String      @id @default(cuid())
  companyId  String
  company    Company     @relation(fields: [companyId], references: [id])
  userId     String?
  user       User?       @relation(fields: [userId], references: [id])
  entity     String
  entityId   String
  action     AuditAction
  oldJson    String?
  newJson    String?
  createdAt  DateTime    @default(now())

  @@index([companyId, entity])
}

model Pendency {
  id            String          @id @default(cuid())
  companyId      String
  company        Company         @relation(fields: [companyId], references: [id])
  transactionId  String
  transaction    Transaction     @relation(fields: [transactionId], references: [id])
  type           PendencyType
  question       String
  priority       PendencyPriority
  status         PendencyStatus
  assignedTo     String
  createdAt      DateTime        @default(now())
  dueAt          DateTime
  resolvedAt     DateTime?
  resolvedBy     String?
  response       String?

  @@index([companyId, status])
  @@index([transactionId])
}

model ImportJob {
  id         String       @id @default(cuid())
  companyId  String
  company    Company      @relation(fields: [companyId], references: [id])
  source     ImportSource
  status     ImportStatus @default(QUEUED)
  filename   String?
  mimeType   String?
  path       String?
  resultJson String?
  error      String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  dataSourceId      String?
  dataSource        DataSource? @relation(fields: [dataSourceId], references: [id])
  origin            String?
  entity            String?
  requestedByUserId String?
  requestedBy       User?        @relation("UserRequestedJobs", fields: [requestedByUserId], references: [id])
  idempotencyKey    String?
  startedAt         DateTime?
  finishedAt        DateTime?
  statsJson         String?
  errorSummary      String?

  @@index([companyId, status])

  rawEvents   RawEvent[]
  importErrors ImportError[]
}

enum DataSourceType {
  ERP_API
  EXCEL
  MANUAL
}

enum DataSourceStatus {
  ACTIVE
  PAUSED
  ERROR
}

enum AuthType {
  NONE
  API_KEY
  OAUTH2
  BASIC
  JWT
}

enum RawEventStatus {
  RECEIVED
  PARSED
  REJECTED
}

model DataSource {
  id          String            @id @default(cuid())
  companyId   String
  company     Company           @relation(fields: [companyId], references: [id])
  type        DataSourceType
  providerKey String
  name        String
  status      DataSourceStatus  @default(ACTIVE)
  baseUrl     String?
  authType    AuthType          @default(NONE)
  authData    String?
  settings    String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  importJobs  ImportJob[]
  importFiles ImportFile[]
  rawEvents   RawEvent[]
  externalRefs ExternalRef[]

  @@unique([companyId, providerKey, name])
  @@index([companyId, status])
}

model ImportFile {
  id                 String   @id @default(cuid())
  companyId          String
  company            Company  @relation(fields: [companyId], references: [id])
  dataSourceId       String?
  dataSource         DataSource? @relation(fields: [dataSourceId], references: [id])
  filename           String
  mimeType           String
  sizeBytes          Int
  storagePath        String
  checksumSha256     String
  uploadedByUserId   String
  uploadedBy         User     @relation(fields: [uploadedByUserId], references: [id])
  uploadedAt         DateTime @default(now())


  @@unique([companyId, checksumSha256])
}

model RawEvent {
  id            String         @id @default(cuid())
  companyId     String
  company       Company        @relation(fields: [companyId], references: [id])
  dataSourceId  String
  dataSource    DataSource     @relation(fields: [dataSourceId], references: [id])
  importJobId   String
  importJob     ImportJob      @relation(fields: [importJobId], references: [id])
  entity        String
  externalId    String?
  payload       String
  payloadHash   String
  receivedAt    DateTime       @default(now())
  status        RawEventStatus @default(RECEIVED)
  error         String?

  @@unique([companyId, dataSourceId, entity, payloadHash])
  @@index([companyId, dataSourceId, entity, receivedAt])

  importErrors ImportError[]
}

model ImportError {
  id           String    @id @default(cuid())
  companyId    String
  company      Company   @relation(fields: [companyId], references: [id])
  importJobId  String
  importJob    ImportJob @relation(fields: [importJobId], references: [id])
  rawEventId   String?
  rawEvent     RawEvent? @relation(fields: [rawEventId], references: [id])
  entity       String
  externalId   String?
  errorCode    String
  message      String
  detailsJson  String?
  createdAt    DateTime  @default(now())
}

model ExternalRef {
  id            String   @id @default(cuid())
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id])
  dataSourceId  String?
  dataSource    DataSource? @relation(fields: [dataSourceId], references: [id])
  entity        String
  externalId    String
  targetTable   String
  targetId      String
  createdAt     DateTime @default(now())

  @@unique([companyId, entity, externalId])
}

enum TitleStatus {
  OPEN
  PAID
  OVERDUE
  CANCELED
}

model Customer {
  id        String   @id @default(cuid())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  name      String
  knownName String?
  externalId String?
  document  String?  @unique
  email     String?
  phone     String?
  phone2    String?
  birthDate DateTime?
  city      String?
  state     String?
  cityId    String?
  cityRef   City?    @relation(fields: [cityId], references: [id])
  stateCode String?
  stateRef  State?   @relation(fields: [stateCode], references: [code])
  neighborhood String?
  value      Float?
  deactivatedAt DateTime?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  arTitles  ArTitle[]
  deactivations CustomerDeactivation[]
  sales     Sale[]

  @@unique([companyId, externalId])
}

model CustomerDeactivation {
  id           String   @id @default(cuid())
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id])
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id])
  value         Float?
  reason        String?
  deactivatedAt DateTime @default(now())
  createdAt     DateTime @default(now())

  @@index([companyId, customerId])
}

model Supplier {
  id        String   @id @default(cuid())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  name      String
  externalId String?
  document  String?  @unique
  email     String?
  phone     String?
  phone2    String?
  city      String?
  state     String?
  cityId    String?
  cityRef   City?    @relation(fields: [cityId], references: [id])
  stateCode String?
  stateRef  State?   @relation(fields: [stateCode], references: [code])
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  apTitles  ApTitle[]

  @@unique([companyId, externalId])
}

model Product {
  id            String   @id @default(cuid())
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id])
  code          String
  externalId    String?
  sku           String?
  barcode       String?
  name          String
  section       String?
  group         String?
  subgroup      String?
  brandName     String?
  costPrice     Float?
  salePrice     Float?
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  saleItems     SaleItem[]

  @@unique([companyId, code])
  @@unique([companyId, externalId])
}

model ApTitle {
  id              String     @id @default(cuid())
  companyId       String
  company         Company    @relation(fields: [companyId], references: [id])
  supplierId      String?
  supplier        Supplier?  @relation(fields: [supplierId], references: [id])
  issueDate       DateTime
  dueDate         DateTime
  amount          Float
  openAmount      Float
  status          TitleStatus
  documentNumber  String?
  notes           String?
  createdAt       DateTime   @default(now())
}

model ArTitle {
  id              String     @id @default(cuid())
  companyId       String
  company         Company    @relation(fields: [companyId], references: [id])
  customerId      String?
  customer        Customer?  @relation(fields: [customerId], references: [id])
  issueDate       DateTime
  dueDate         DateTime
  amount          Float
  openAmount      Float
  status          TitleStatus
  documentNumber  String?
  notes           String?
  createdAt       DateTime   @default(now())
}

model StgCustomer {
  id                String   @id @default(cuid())
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id])
  dataSourceId      String
  importJobId       String
  rawEventId        String
  externalCustomerId String
  name              String
  document          String?
  email             String?
  phone             String?
  city              String?
  state             String?
  isActive          Boolean  @default(true)
  updatedAtSource   DateTime?
  createdAt         DateTime @default(now())

  @@unique([companyId, dataSourceId, externalCustomerId])
}

model StgSupplier {
  id                  String   @id @default(cuid())
  companyId           String
  company             Company  @relation(fields: [companyId], references: [id])
  dataSourceId        String
  importJobId         String
  rawEventId          String
  externalSupplierId  String
  name                String
  document            String?
  email               String?
  phone               String?
  city                String?
  state               String?
  isActive            Boolean  @default(true)
  updatedAtSource     DateTime?
  createdAt           DateTime @default(now())

  @@unique([companyId, dataSourceId, externalSupplierId])
}

model StgProduct {
  id                 String   @id @default(cuid())
  companyId          String
  company            Company  @relation(fields: [companyId], references: [id])
  dataSourceId       String
  importJobId        String
  rawEventId         String
  externalProductId  String
  sku                String?
  barcode            String?
  name               String
  categoryPath       String?
  brandName          String?
  costPrice          Float?
  salePrice          Float?
  active             Boolean @default(true)
  updatedAtSource    DateTime?
  createdAt          DateTime @default(now())

  @@unique([companyId, dataSourceId, externalProductId])
}

model StgInventory {
  id                 String   @id @default(cuid())
  companyId          String
  company            Company  @relation(fields: [companyId], references: [id])
  dataSourceId       String
  importJobId        String
  rawEventId         String
  externalProductId  String
  externalLocationId String?
  locationName       String?
  qtyOnHand          Float
  updatedAtSource    DateTime?
  createdAt          DateTime @default(now())

  @@index([companyId, externalProductId])
}

model StgSalesInvoice {
  id                 String   @id @default(cuid())
  companyId          String
  company            Company  @relation(fields: [companyId], references: [id])
  dataSourceId       String
  importJobId        String
  rawEventId         String
  externalInvoiceId  String
  invoiceNumber      String
  issueDate          DateTime
  externalCustomerId String?
  totalAmount        Float
  discountAmount     Float?
  freightAmount      Float?
  status             String
  updatedAtSource    DateTime?
  createdAt          DateTime @default(now())

  items StgSalesInvoiceItem[]
}

model StgSalesInvoiceItem {
  id                   String   @id @default(cuid())
  companyId            String
  stgSalesInvoiceId    String
  stgSalesInvoice      StgSalesInvoice @relation(fields: [stgSalesInvoiceId], references: [id])
  externalProductId    String?
  description          String
  qty                  Float
  unitPrice            Float
  totalPrice           Float
  costEstimate         Float?
  createdAt            DateTime @default(now())
}

model StgPurchaseInvoice {
  id                  String   @id @default(cuid())
  companyId           String
  company             Company  @relation(fields: [companyId], references: [id])
  dataSourceId        String
  importJobId         String
  rawEventId          String
  externalInvoiceId   String
  invoiceNumber       String
  issueDate           DateTime
  externalSupplierId  String?
  totalAmount         Float
  discountAmount      Float?
  freightAmount       Float?
  status              String
  updatedAtSource     DateTime?
  createdAt           DateTime @default(now())

  items StgPurchaseInvoiceItem[]
}

model StgPurchaseInvoiceItem {
  id                    String   @id @default(cuid())
  companyId             String
  stgPurchaseInvoiceId  String
  stgPurchaseInvoice    StgPurchaseInvoice @relation(fields: [stgPurchaseInvoiceId], references: [id])
  externalProductId     String?
  description           String
  qty                   Float
  unitPrice             Float
  totalPrice            Float
  costEstimate          Float?
  createdAt             DateTime @default(now())
}

model State {
  code      String   @id
  name      String
  createdAt DateTime @default(now())

  cities    City[]
  customers Customer[]
  suppliers Supplier[]
}

model City {
  id        String   @id @default(cuid())
  name      String
  stateCode String
  state     State    @relation(fields: [stateCode], references: [code])
  createdAt DateTime @default(now())

  customers Customer[]
  suppliers Supplier[]
  @@index([stateCode, name])
}
